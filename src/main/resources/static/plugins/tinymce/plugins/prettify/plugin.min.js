/**
 * plugin.js
 *
 * Released under LGPL License.
 * Copyright (c) 1999-2015 Ephox Corp. All rights reserved
 *
 * License: http://www.tinymce.com/license
 * Contributing: http://www.tinymce.com/contributing
 */

/*global tinymce:true */

tinymce.PluginManager.add('prettify', function (editor, url) {
    // var isArray = tinymce.util.Tools.isArray;

    function escapeHtml(text) {
        return text.replace(/&/g, "&amp;").replace(/"/g, "&quot;").replace(/'/g, "'").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    function showDialog() {
        var win = editor.windowManager.open({
            title: '插入代码',
            width: 800,
            height: 540,
            html: [
                '<form name="prettify" action="#" style="padding:20px;width:800px;">',
                '    <h3>插入代码：</h3>',
                '    <div><textarea name="" style="border: 1px solid #E1E1E1;height:300px; width:780px; margin: 0;resize: none"  id="prettify_code"></textarea>',
                '    </div>',
                '    <table border="0" cellpadding="4" cellspacing="0"  style="margin-top:15px;width: 400px ">',
                '        <tbody>',
                '        <tr>',
                '            <td nowrap="nowrap" valign="top" style="padding:6px 0;width: 100px">选择语言</td>',
                '            <td  style="padding:6px 0"><select id="prettify_lang">  ' +
                '                    <option value="C">C</option>' +
                '                    <option value="Java">Java</option>' +
                '                    <option value="Python">Python</option>' +
                '                    <option value="HTML">HTML</option>' +
                '                    <option value="XML">XML</option>' +
                '                    <option value="Javascript">Javascript</option>' +
                '                    <option value="PHP">PHP</option>' +
                '                    <option value="Perl">Perl</option>' +
                '                    <option value="CSS">CSS</option>' +
                '                    <option value="Go">Go</option>' +
                '                    <option value="Dart">Dart</option>' +
                '                    <option value="Haskell">Haskell</option>' +
                '                    <option value="Lua">Lua</option>' +
                '                    <option value="Pascal">Pascal</option>' +
                '                    <option value="SQL">SQL</option>' +
                '                    <option value="R">R</option>' +
                '                    <option value="Swift">Swift</option>' +
                '                    <option value="Bash">Bash</option>' +
                '                    <option value="VB">VB</option>' +
                '                    </select></td>' +
                '        </tr>',
                '        <tr>',
                '            <td nowrap="nowrap" valign="top" style="padding:6px 0"><label for="prettify_filename">文件名</label></td>',
                '            <td style="padding:6px 0"><input type="text" name="filename" id="prettify_filename" value=""></td>',
                '        </tr>',
                '        <tr>',
                '            <td nowrap="nowrap" valign="top" style="padding:6px 0"><label for="prettify_linenumber">开始行</label></td>',
                '            <td style="padding:6px 0"><input type="text" name="linenumber" id="prettify_linenumber" value="1" size="3"> 开始行号</td>',
                '        </tr>',
                '        <tr>',
                '            <td nowrap="nowrap" valign="top" style="padding:6px 0"><label for="prettify_importlines">重点行</label></td>',
                '            <td style="padding:6px 0"><input type="text" name="importlines" id="prettify_importlines" value=""> 从1开始索引，多号以英文逗号 "," 隔开</td>',
                '        </tr>',
                '        </tbody>',
                '    </table>',
                '</form>'].join(""),
            buttons: [{
                text: ' 插入代码 ',
                subtype: 'primary',
                style: 'width:88px',
                onclick: function () {
                    insertContents()
                }
            },
                {
                    text: 'Close',
                    onclick: 'close'
                }]

        });

        function insertContents() {
            var $win = $(win.$el);
            var langname = $win.find('#prettify_lang option:selected').val();

            var linenumber = $.trim($win.find('#prettify_linenumber').val());
            var filename = $.trim($win.find('#prettify_filename').val());
            var importlines = $.trim($win.find('#prettify_importlines').val());
            var html = escapeHtml($win.find('#prettify_code').val());
            tagtext = ('<pre class="prettyprint lang-' + langname + ' linenums:' + linenumber);
            // console.log(tagtext);
            if (!!filename) {
                tagtext += ' filename-' + filename;
            }
            if (!!importlines) {
                tagtext += ' importlines:' + importlines;
            }
            tagtext += '" >' + html + '</pre>';
            console.log(tagtext);
            editor.insertContent(tagtext);
            win.close();
        }
    }

    editor.addCommand('prettify', showDialog);

    editor.addButton('prettify', {
        title: '插入代码',
        cmd: 'prettify',
        image: url + '/img/prettify.png'
    });


    editor.addMenuItem('prettify', {
        cmd: 'prettify',
        image: url + '/img/prettify.png',
        text: '插入代码',
        context: 'tools',
    });
    return {};
});