

tinymce.PluginManager.add('uploadimage', function (ed, url) {
    url = tinyMCE.activeEditor.getParam('uploadimage_rel') || url;
    var uploadimageUrl = tinyMCE.activeEditor.getParam('uploadimage_url');
    console.log('url'+url)
    console.log('uploadimageUrl'+uploadimageUrl)
    var $win;
    function showdiago() {
        layer.open({
            type: 1,
            skin: 'layui-layer-rim', //加上边框
            area: ['420px', '240px'], //宽高
            content:    '<form  method="POST"  enctype="multipart/form-data" id="uploadImageForm">' +
            '                                   <button type="button" class="layui-btn" id="image-afdasdff3" style="margin-top: 50px;margin-left: 130px  ">' +
        '                            <i class="layui-icon">&#xe67c;</i>上传图片' +
        '                        </button>' +
            '  </form>'
        });

            layui.use([ 'form', 'upload'], function () {
                var form = layui.form
                    , $ = layui.jquery
                    , upload = layui.upload
                upload.render({
                    url:  uploadimageUrl
                    , elem: '#image-afdasdff3'
                    , ext: 'jpg|png|gif'
                    , before: function (input) {
                        loading = layer.load(2, {
                            shade: [0.2, '#000']
                        });
                    }
                    , done: function (res) {
                        layer.close(loading);
                        layer.msg(res.msg, {icon: 1, time: 1000});
                        // $('#uploaded-image').attr('src',getRootPath_web()+res.path);
                        var tpl = '<img src="%s" />';
                        var tmppath = res.file.url;
                         console.log(tmppath);
                         console.log( tpl.replace('%s', tmppath));
                        ed.insertContent(tpl.replace('%s', tmppath));
                        ed.focus();
                        layer.closeAll('page'); //关闭所有页面层
                    }, error: function () {
                        layer.close(index);
                        layer.msg('上传出错：1', {
                            title: '提示'
                            //不自动关闭
                            , time: 1000
                            , icon: 5
                            , offset: '400px'
                        });
                    }
                });

            });
    }
// Register commands
    ed.addCommand('uploadimage', showdiago);


// Register buttons
    ed.addButton('uploadimage', {
        title: '插入图片',
        cmd: 'uploadimage',
        image: url + '/img/icon.png',
    });


})
;