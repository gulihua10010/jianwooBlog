<title>网站配置</title>

<div class="layui-card layadmin-header">
    <div class="layui-breadcrumb" lay-filter="breadcrumb">
        <a lay-href="">主页</a>
        <a><cite>系统管理</cite></a>
        <a><cite>网站配置</cite></a>
    </div>
</div>
<div class="layui-fluid">
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md12">
            <div class="layui-card">
                <div class="layui-card-header">网站配置</div>
                <div class="layui-card-body">
                    <div class="layui-form" id="layuiadmin-form-comment" lay-filter="layuiadmin-form-comment">
                        <div class="layui-card-body">
                            <script type="text/html" template lay-url="/api/admin/webconf/info" id="JW_WEBCONFIG_VIEW"
                                    lay-done="renderWebconfig(d)">

                                {{# layui.each(d.data, function(index, item){ }}
                                {{#  if(item.formType === 'INPUT_TEXT'){ }}
                                <div class="layui-form-item">
                                    <label class="layui-form-label">{{ item.title }}</label>
                                    <div class="layui-input-block">
                                        <input class="layui-input web-form" name="{{ item.key }}" data-key="{{item.formType}}" title="{{ item.title }}"
                                               lay-verify="{{#  if(item.mandatory){ }}required{{#  } }}|{{item.validateType}}"
                                               {{ validateValue(item.validateType,item.validateValue) }}
                                               data-validateType="{{item.validateType}}" data-validateValue="{{formatValidateValue(item.validateValue)}}"
                                               data-mandatory="{{item.mandatory}}" data-valueType="{{item.valueType}}" data-oldValue="{{=item.value}}"
                                               value="{{=item.value}}" type="text">
                                    </div>
                                </div>
                                {{#  } }}
                                {{#  if(item.formType === 'TEXTAREA'){ }}
                                <div class="layui-form-item">
                                    <label class="layui-form-label">{{ item.title }}</label>
                                    <div class="layui-input-block">
                                        <textarea class="layui-textarea web-form" name="{{ item.key }}" data-key="{{item.formType}}" title="{{ item.title }}"
                                                  data-validateType="{{item.validateType}}" data-validateValue="{{item.validateValue}}"
                                                  lay-verify="{{#  if(item.mandatory){ }}required|{{#  } }}{{item.validateType}}"
                                                  {{ validateValue(item.validateType,item.validateValue) }}
                                                  data-validateType="{{item.validateType}}" data-validateValue="{{formatValidateValue(item.validateValue)}}"
                                                  data-mandatory="{{item.mandatory}}" data-valueType="{{item.valueType}}" data-oldValue="{{=item.value}}"
                                                  type="text">{{=item.value}}</textarea>
                                    </div>
                                </div>
                                {{#  } }}
                                {{#  if(item.formType === 'INPUT_TEXT_NUMBER'){ }}
                                <div class="layui-form-item">
                                    <label class="layui-form-label">{{ item.title }}</label>
                                    <div class="layui-input-block">
                                        <input class="layui-input web-form" name="{{item.key}}" title="{{ item.title }}"
                                               value="{{formatNum(item.value)}}" data-key="{{item.formType}}"
                                               lay-verify="number|{{#  if(item.mandatory){ }}required|{{#  } }}{{item.validateType}}"
                                               {{ validateValue(item.validateType,item.validateValue) }}
                                               data-validateType="{{item.validateType}}" data-validateValue="{{formatValidateValue(item.validateValue)}}"
                                               data-mandatory="{{item.mandatory}}" data-valueType="{{item.valueType}}" data-oldValue="{{=item.value}}"
                                               type="text">
                                    </div>
                                </div>
                                {{#  } }}
                                {{#  if(item.formType === 'INPUT_FILE_IMAGE'){ }}
                                <div class="layui-form-item">
                                    <label class="layui-form-label">{{ item.title }}</label>
                                    <div class="layui-input-block">
                                        <button class="layui-btn" id="{{item.key}}-BTN" type="button">上传图片</button>
                                        <div class="layui-upload-list imgupload">
                                            <img class="layui-upload-img" id="{{item.key}}-IMG"
                                                 style="margin-left: 5px" src="{{item.value}}"
                                                 {{computeWidth(item.key)}}>
                                            <p id="{{item.key}}-TEXT"></p>
                                            <input id="{{item.key}}-SRC"  class="web-form" data-key="{{item.formType}}" title="{{ item.title }}"
                                                   name="{{item.key}}" style="visibility: hidden"
                                                   lay-verify="{{#  if(item.mandatory){ }}required{{#  } }}{{item.validateType}}"
                                                   data-validateType="{{item.validateType}}" data-validateValue="{{formatValidateValue(item.validateValue)}}"
                                                   data-mandatory="{{item.mandatory}}" data-valueType="{{item.valueType}}" data-oldValue="{{=item.value}}"
                                                   value="{{=item.value}}">
                                        </div>
                                    </div>
                                </div>
                                {{ upload(item.key)}}
                                {{#  } }}
                                {{#  if(item.formType === 'INPUT_CHECKBOX'){ }}
                                <div class="layui-form-item">
                                    <label class="layui-form-label">{{ item.title }}</label>
                                    <div class="layui-input-block">
                                        <input id="{{item.key}}" class="web-form" name="{{item.key}}"
                                               {{check(item.value)}} data-key="{{item.formType}}"
                                               lay-verify="{{#  if(item.mandatory){ }}required{{#  } }}{{item.validateType}}"
                                               title="{{item.title}}"  data-mandatory="{{item.mandatory}}"  data-valueType="{{item.valueType}}"
                                               data-validateType="{{item.validateType}}" data-validateValue="{{formatValidateValue(item.validateValue)}}"
                                               type="checkbox" value="1"  data-oldValue="{{item.value}}">
                                    </div>
                                </div>
                                {{#  } }}

                                {{# }); }}
                                <div class="layui-form-item">
                                    <label class="layui-form-label"></label>
                                    <div class="layui-input-block">
                                        <input class="layui-btn" id="submit" lay-filter="submit-webconf" lay-submit
                                               style="float: right" type="button" value="确认">
                                    </div>
                                </div>
                            </script>
                        </div>
                    </div>


                </div>
            </div>
        </div>
    </div>
</div>
<script>
    function renderWebconfig(d) {
        layui.use('web', layui.factory('web')).use(['admin', 'web', 'form'], function () {
            var form = layui.form
                , $ = layui.jquery
            ;
            form.render();

        })
    }

    function upload(key) {
        var idx;
        layui.use(['upload'], function () {
            var form = layui.form
                , upload = layui.upload
                , $ = layui.jquery
            ;


            var upFile = upload.render({
                elem: '#' + key + '-BTN'
                , url: '/api/file/upload'
                , before: function (obj) {
                    //预读本地文件示例，不支持ie8
                    obj.preview(function (index, file, result) {
                        $('#' + key + "-IMG").attr('src', result); //图片链接（base64）
                        // $('#LOGO-IMG').attr('src', result); //图片链接（base64）

                    });
                    idx = layer.load(0, {shade: false, offset: '400px'}, {time: 3000});
                }
                , done: function (res, index) {
                    layer.close(idx);
                    $('result').text(res.status);
                    if (res.status) {
                        layer.msg('上传成功', {
                            title: '提示'
                            //不自动关闭
                            , time: 1000
                            , icon: 6
                            , offset: '400px'
                        });
                        $('#' + key + '-SRC').val(res.file.url);
                    }
                    //上传成功
                }
                , error: function () {
                    layer.close(index);
                    layer.msg('上传出错：1', {
                        title: '提示'
                        //不自动关闭
                        , time: 1000
                        , icon: 5
                        , offset: '400px'
                    });
                    //演示失败状态，并实现重传
                    var demoText = $('#' + key + '-TEXT');
                    demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-mini demo-reload">重试</a>');
                    demoText.find('.demo-reload').on('click', function () {
                        upFile.upload();
                    });
                }
            })

        })
    }

    function validateValue(key, value) {
        if (key === undefined || key === '' || value === undefined || value === '') {
            return '';
        }
        var validateArr = key.split("|");
        var res = "";
        value = JSON.parse(value)
        for (var i = 0; i < validateArr.length; i++) {
            var v = value[validateArr[i]];
            if (v && v['lay-verify']) {
                res = res + v['lay-verify'] + " ";
            }
        }
        return res;
    }
    function formatValidateValue(v)
    {
        if(!v) return ''
        return v.replaceAll('\"',"\\");
    }
    function formatNum(v)
    {
        if(!v) return ''
        return parseInt(v);
    }

    function check(value) {
        if (value === 'true') {
            return 'checked'
        }
        return '';
    }

    function computeWidth(key) {
        if (key === 'TOP_IMG') {
            return 'width="500"'
        }
        return 'width="100"';

    }

</script>