/*!
 * upload 文件上传组件
 *  * 数据表格组件扩展，支持读取响应数据的header，以获取token
 * MIT Licensed
 */
;layui.define("layer",function(t){var d=layui.$,s=layui.layer,j=layui.hint(),l=layui.device(),q=layui.setter,r={config:{},set:function(u){var v=this;v.config=d.extend({},v.config,u);return v},on:function(u,v){return layui.onevent.call(this,g,u,v)}},o=function(){var u=this;return{upload:function(v){u.upload.call(u,v)},reload:function(v){u.reload.call(u,v)},config:u.config}},g="layupload",a="layui-upload",f="layui-this",c="layui-show",n="layui-hide",p="layui-disabled",e="layui-upload-file",i="layui-upload-form",k="layui-upload-iframe",h="layui-upload-choose",b="layui-upload-drag",m=function(u){var v=this;v.config=d.extend({},v.config,r.config,u);v.render()};m.prototype.config={accept:"images",exts:"",auto:true,bindAction:"",url:"",field:"file",acceptMime:"",method:"post",data:{},drag:true,size:0,number:0,multiple:false};m.prototype.render=function(u){var v=this,u=v.config;u.elem=d(u.elem);u.bindAction=d(u.bindAction);v.file();v.events()};m.prototype.file=function(){var w=this,u=w.config,x=w.elemFile=d(['<input class="'+e+'" type="file" accept="'+u.acceptMime+'" name="'+u.field+'"',(u.multiple?" multiple":""),">"].join("")),v=u.elem.next();if(v.hasClass(e)||v.hasClass(i)){v.remove()}if(l.ie&&l.ie<10){u.elem.wrap('<div class="layui-upload-wrap"></div>')}w.isFile()?(w.elemFile=u.elem,u.field=u.elem[0].name):u.elem.after(x);if(l.ie&&l.ie<10){w.initIE()}};m.prototype.initIE=function(){var w=this,u=w.config,v=d('<iframe id="'+k+'" class="'+k+'" name="'+k+'" frameborder="0"></iframe>'),x=d(['<form target="'+k+'" class="'+i+'" method="post" key="set-mine" enctype="multipart/form-data" action="'+u.url+'">',"</form>"].join(""));d("#"+k)[0]||d("body").append(v);if(!u.elem.next().hasClass(i)){w.elemFile.wrap(x);u.elem.next("."+i).append(function(){var y=[];layui.each(u.data,function(z,A){A=typeof A==="function"?A():A;y.push('<input type="hidden" name="'+z+'" value="'+A+'">')});return y.join("")}())}};m.prototype.msg=function(u){return s.msg(u,{icon:2,shift:6})};m.prototype.isFile=function(){var u=this.config.elem[0];if(!u){return}return u.tagName.toLocaleLowerCase()==="input"&&u.type==="file"};m.prototype.preview=function(v){var u=this;if(window.FileReader){layui.each(u.chooseFiles,function(x,y){var w=new FileReader();w.readAsDataURL(y);w.onload=function(){v&&v(x,y,this.result)}})}};m.prototype.upload=function(u,E){var B=this,H=B.config,A=B.elemFile[0],I=function(){var M=0,L=0,K=u||B.files||B.chooseFiles||A.files,J=function(){if(H.multiple&&M+L===B.fileLength){typeof H.allDone==="function"&&H.allDone({total:B.fileLength,successful:M,aborted:L})}};layui.each(K,function(N,O){var Q=new FormData();Q.append(H.field,O);layui.each(H.data,function(R,S){S=typeof S==="function"?S():S;Q.append(R,S)});if(q){H.headers=H.headers||{};H.headers[q.request.tokenName]=q.request.tokenName in H.headers?H.headers[q.request.tokenName]:(layui.data(q.tableName)[q.request.tokenName]||"");H.headers[q.request.refreshTokenName]=q.request.refreshTokenName in H.headers?H.headers[q.request.refreshTokenName]:(layui.data(q.tableName)[q.request.refreshTokenName]||"")}var P={url:H.url,type:"post",data:Q,contentType:false,processData:false,dataType:"json",headers:H.headers||{},success:function(R){M++;z(N,R);J()},error:function(R){L++;B.msg("请求上传接口出现异常");var S=R.responseJSON;if(S&&S.status==q.response.statusCode.logout){layui.view&&layui.view.exit()}D(N);J()},complete:function(T,S){var R=T.getResponseHeader(q.request.refreshAccessTokenName);if(R){layui.data(q.tableName,{key:q.request.tokenName,value:R})}}};if(typeof H.progress==="function"){P.xhr=function(){var R=d.ajaxSettings.xhr();R.upload.addEventListener("progress",function(T){if(T.lengthComputable){var S=Math.floor((T.loaded/T.total)*100);H.progress(S,(H.item?H.item[0]:H.elem[0]),T,N)}});return R}}d.ajax(P)})},F=function(){var J=d("#"+k);B.elemFile.parent().submit();clearInterval(m.timer);m.timer=setInterval(function(){var K,L=J.contents().find("body");try{K=L.text()}catch(M){B.msg("获取上传后的响应信息出现异常");clearInterval(m.timer);D()}if(K){clearInterval(m.timer);L.html("");z(0,K)}},30)},z=function(J,K){B.elemFile.next("."+h).remove();A.value="";if(typeof K!=="object"){try{K=JSON.parse(K)}catch(L){K={};return B.msg("请对上传接口返回有效JSON")}}typeof H.done==="function"&&H.done(K,J||0,function(M){B.upload(M)})},D=function(J){if(H.auto){A.value=""}typeof H.error==="function"&&H.error(J||0,function(K){B.upload(K)})},y=H.exts,v,G=function(){var J=[];layui.each(u||B.chooseFiles,function(K,L){J.push(L.name)});return J}(),C={preview:function(J){B.preview(J)},upload:function(K,L){var J={};J[K]=L;B.upload(J)},pushFile:function(){B.files=B.files||{};layui.each(B.chooseFiles,function(J,K){B.files[J]=K});return B.files},resetFile:function(L,M,K){var J=new File([M],K);B.files=B.files||{};B.files[L]=J}},w=function(){if(E==="choose"||H.auto){H.choose&&H.choose(C);if(E==="choose"){return}}if(H.before&&(H.before(C)===false)){return}if(l.ie){return l.ie>9?I():F()}I()};G=G.length===0?((A.value.match(/[^\/\\]+\..+/g)||[])||""):G;if(G.length===0){return}switch(H.accept){case"file":if(y&&!RegExp("\\w\\.("+y+")$","i").test(escape(G))){B.msg("选择的文件中包含不支持的格式");return A.value=""}break;case"video":if(!RegExp("\\w\\.("+(y||"avi|mp4|wma|rmvb|rm|flash|3gp|flv")+")$","i").test(escape(G))){B.msg("选择的视频中包含不支持的格式");return A.value=""}break;case"audio":if(!RegExp("\\w\\.("+(y||"mp3|wav|mid")+")$","i").test(escape(G))){B.msg("选择的音频中包含不支持的格式");return A.value=""}break;default:layui.each(G,function(J,K){if(!RegExp("\\w\\.("+(y||"jpg|png|gif|bmp|jpeg$")+")","i").test(escape(K))){v=true}});if(v){B.msg("选择的图片中包含不支持的格式");return A.value=""}break}B.fileLength=function(){var K=0,J=u||B.files||B.chooseFiles||A.files;layui.each(J,function(){K++});return K}();if(H.number&&B.fileLength>H.number){return B.msg("同时最多只能上传的数量为："+H.number)}if(H.size>0&&!(l.ie&&l.ie<10)){var x;layui.each(B.chooseFiles,function(J,L){if(L.size>1024*H.size){var K=H.size/1024;K=K>=1?(K.toFixed(2)+"MB"):H.size+"KB";A.value="";x=K}});if(x){return B.msg("文件不能超过"+x)}}w()};m.prototype.reload=function(u){u=u||{};delete u.elem;delete u.bindAction;var w=this,u=w.config=d.extend({},w.config,r.config,u),v=u.elem.next();v.attr({name:u.name,accept:u.acceptMime,multiple:u.multiple})};m.prototype.events=function(){var w=this,u=w.config,v=function(y){w.chooseFiles={};layui.each(y,function(z,A){var B=new Date().getTime();w.chooseFiles[B+"-"+z]=A})},x=function(A,y){var C=w.elemFile,z=u.item?u.item:u.elem,B=A.length>1?A.length+"个文件":((A[0]||{}).name||(C[0].value.match(/[^\/\\]+\..+/g)||[])||"");if(C.next().hasClass(h)){C.next().remove()}w.upload(null,"choose");if(w.isFile()||u.choose){return}C.after('<span class="layui-inline '+h+'">'+B+"</span>")};u.elem.off("upload.start").on("upload.start",function(){var z=d(this),y=z.attr("lay-data");if(y){try{y=new Function("return "+y)();w.config=d.extend({},u,y)}catch(A){j.error("Upload element property lay-data configuration item has a syntax error: "+y)}}w.config.item=z;w.elemFile[0].click()});if(!(l.ie&&l.ie<10)){u.elem.off("upload.over").on("upload.over",function(){var y=d(this);y.attr("lay-over","")}).off("upload.leave").on("upload.leave",function(){var y=d(this);y.removeAttr("lay-over")}).off("upload.drop").on("upload.drop",function(A,B){var z=d(this),y=B.originalEvent.dataTransfer.files||[];z.removeAttr("lay-over");v(y);if(u.auto){w.upload(y)}else{x(y)}})}w.elemFile.off("upload.change").on("upload.change",function(){var y=this.files||[];v(y);u.auto?w.upload():x(y)});u.bindAction.off("upload.action").on("upload.action",function(){w.upload()});if(u.elem.data("haveEvents")){return}w.elemFile.on("change",function(){d(this).trigger("upload.change")});u.elem.on("click",function(){if(w.isFile()){return}d(this).trigger("upload.start")});if(u.drag){u.elem.on("dragover",function(y){y.preventDefault();d(this).trigger("upload.over")}).on("dragleave",function(y){d(this).trigger("upload.leave")}).on("drop",function(y){y.preventDefault();d(this).trigger("upload.drop",y)})}u.bindAction.on("click",function(){d(this).trigger("upload.action")});u.elem.data("haveEvents",true)};r.render=function(u){var v=new m(u);return o.call(v)};t(g,r)});