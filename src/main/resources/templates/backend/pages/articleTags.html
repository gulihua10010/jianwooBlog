<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta content="webkit" name="renderer">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0"
          name="viewport">
    <link href="/static/plugins/layuiadmin/layui/css/layui.css" media="all" rel="stylesheet">
    <link href="/static/plugins/layuiadmin/plugins/mouseRightMenu.css" media="all" rel="stylesheet">
    <link href="/static/css/admin.css" media="all" rel="stylesheet">
    <title>文章标签</title>
<style>
    .tags-show-block {
        line-height: 35px;
        padding: 2px 0;

    }

    .tags-show {
        background-color: #eee;
        line-height: 35px;
        padding: 3px 7px;
        border-radius: 5px;
        text-align: center;
        font-size: 20px;
        /*border-right: 1px #aaa solid;*/
        overflow: hidden;
        margin: 0 3px;
    }


</style>
</head>
<body>


<div class="layui-fluid">
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md12">
            <div class="layui-card">
                <div class="layui-card-header">文章标签</div>
                <div class="layui-card-body">
                    <div class="tags-content">
                        <ul>
                            <li th:each="tag:${tags}" th:attr="data-id=${tag.oid},data-text=${tag.content}">
                                <span th:text="${tag.content}"></span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="layui-card">
                <div class="layui-card-header">添加标签</div>
                <div class="layui-card-body">
                    <div class="add-tags layui-input">
                        <span class="tags-show-block">
                        </span>
                        <input class="add-tags-dynamic-input" name="text" type="text" id="tags-add-text"
                               autocomplete="off">
                    </div>
                    <div class="layui-form-item add-tags-btn">
                        <span>添加标签，可用逗号(,)分隔</span>
                        <input class="layui-btn" id="add-tags"
                               type="button" value="添加">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/static/plugins/layuiadmin/layui/layui.js"></script>
<script src="/static/js/common.js" type="text/javascript"></script>
<script>
    layui.config({
        base: '/static/plugins/layuiadmin/' //静态资源所在路径
    }).extend({
        index: 'lib/index'
        , mouseRightMenu: '/mouseRightMenu'
    }).use(['index', 'mouseRightMenu', 'layer'], function () {
        var $ = layui.jquery
            , layer = layui.layer
            , mouseRightMenu = layui.mouseRightMenu;

        doRenderTags('.tags-content > ul > li')

        document.oncontextmenu = function () {
            return false;
        }
        var token;
        ajaxApiPost(
            "/api/admin/token/generate",
            JSON.stringify({
                pageId: 'T14',
            }),
            function (res) {
                token = res.token;
            }
        );
        console.log($('.tags-show-block').css('width'))
        computeInputWidth()

        $('.tags-content > ul > li').bind("contextmenu", function (e) {
            var data = {oid: $(this).data('id'), text: $(this).data('text')}
            var menu_data = [
                {'data': data, 'type': 1, 'title': '编辑'},
                {'data': data, 'type': 2, 'title': '删除'},

            ]
            mouseRightMenu.open(menu_data, false, function (d) {
                if (d.type == 1) {
                    layer.open({
                        type: 2
                        , title: '标签编辑'
                        , content: '/admin/tags/edit/' + d.data.oid
                        , area: ['450px', '200px']
                        , btn: ['确定', '取消']
                        , yes: function (index, layero) {
                            var iframeWindow = window['layui-layer-iframe' + index]
                                , submitID = 'replyComm-submit'
                                , submit = layero.find('iframe').contents().find('#' + submitID);

                            //监听提交
                            iframeWindow.layui.form.on('submit(' + submitID + ')', function (formData) {
                                var field = formData.field; //获取提交的字段

                                ajaxPost(
                                    '/api/admin/tag/update',
                                    JSON.stringify({tagText: field.text, oid: d.data.oid, subToken: field.subToken}),
                                    "更新成功",
                                    function () {
                                        location.reload();
                                    }
                                );

                            });

                            submit.trigger('click');
                        }
                        , success: function (layero, index) {

                        }
                    });


                } else if (d.type == 2) {
                    alert_ask('确定要删除吗?', function () {
                        ajaxPost(
                            '/api/admin/tag/remove',
                            JSON.stringify({entityOid: d.data.oid}),
                            "删除成功",
                            function () {
                                location.reload();
                            }
                        );
                        // $a.css('display','none');
                        // layer.closeAll();
                    })
                }
            })
            return false;
        });
        // $('.added-tags-block').html("<span class='tags-show'>"+11+"</span>")

        $("#tags-add-text").unbind("input propertychange").bind('input propertychange', function () {
            if ($(this).prop('comStart')) return; // 中文输入过程中不截断
            var val = $(this).val();
            doProcessTagsInput(val);
        }).on('compositionstart', function () {
            $(this).prop('comStart', true);
        }).on('compositionend', function () {
            $(this).prop('comStart', false);
            var val = $(this).val();
            doProcessTagsInput(val);
        });

        var count = 0;

        function doProcessTagsInput(val) {
            var lastVal = val.substr(val.length - 1);
            var tag = val.substr(0, val.length - 1);
            // console.log(val)
            if (isEmpty(lastVal) || (lastVal == val && lastVal == ',')) {
                $('#tags-add-text').val(tag);
                return;
            }
            if (val.length > 10 && lastVal != ',') {
                alert_fail("提示", "标签最大支持10个字符！");
                $('#tags-add-text').val(val.substr(0, 10));
                return;
            }
            // console.log(lastVal)
            if (lastVal == ",") {
                // $('.tags-show-block').appendTo('<span class="tags-show">' + tag + '</span>');
                var t = $('<span class="tags-show">' + html2Escape(tag) + '</span>')
                $('.tags-show-block').append(t);
                doRenderTag('.tags-show:last', count++);
                $('#tags-add-text').val('');
                // computeInputWidth();
            }
        }

        function doRenderTags(doms) {
            var tags = $(doms);
            for (var i = 0; i < tags.length; i++) {
                doRenderTag(tags[i], i)
            }
        }

        function doRenderTag(dom, i) {

            var color = Math.random();
            var r = parseInt((color * (i + 1) * 1234) % 254);
            var g = parseInt((color * (i + 1) * 4321) % 254);
            var b = parseInt((color * (i + 1) * 2222) % 254);
            $(dom).css("background-color", "rgba(" + r + "," + g + "," + b + ",0.1)")
            $(dom).css("border", "  1px rgba(" + r + "," + g + "," + b + ",1) solid")
        }

        function computeInputWidth() {
            var bodyWidth = $('body').css('width');
            var spanWidth = $('.tags-show-block').css('width');
            $('.add-tags-dynamic-input').css('width', (parseInt(bodyWidth) - parseInt(spanWidth)) + 'px');
        }

        $('#add-tags').click(function () {
            var text = $('#tags-add-text').val();
            if (text == null || $.trim(text) == '') {
                return false;
            }
            var tags = text.trim().split(',');
            for (var i in tags) {
                var tag = tags[i].trim();
                if (tags.length > 10) {
                    alert_fail("列表中标签名不得超过十个字符！");
                    return false;
                }
            }
            ajaxPost(
                '/api/admin/tag/add/list',
                JSON.stringify({tagList: tags, subToken: token}),
                "添加成功",
                function () {
                    location.reload();
                }
            );


        })

    })
</script>
</body>
</html>