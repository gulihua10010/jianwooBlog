<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta content="webkit" name="renderer">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0"
          name="viewport">
    <link href="/static/plugins/layuiadmin/layui/css/layui.css" media="all" rel="stylesheet">
    <link href="/static/plugins/layuiadmin/plugins/mouseRightMenu.css" media="all" rel="stylesheet">
    <link href="/static/css/admin.css" media="all" rel="stylesheet">
    <title>文章标签</title>
    <style>
        .tags-show-block {
            line-height: 35px;
            padding: 2px 0;
            white-space: nowrap;
            height: 100%;


        }

        .tags-show {
            background-color: #eee;
            line-height: 35px;
            padding: 3px 7px;
            border-radius: 5px;
            text-align: center;
            font-size: 20px;
            /*border-right: 1px #aaa solid;*/
            overflow: hidden;
            margin: 0 3px;
            white-space: nowrap;
            width: 100%;
        }


    </style>
</head>
<body>


<div class="layui-fluid">
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md12">
            <div class="layui-card">
                <div class="layui-card-header">文章标签</div>
                <div class="layui-card-body">
                    <div class="tags-content">
                        <ul>
                            <li th:each="tag:${tags}" th:attr="data-id=${tag.oid},data-text=${tag.content}">
                                <span th:text="${tag.content}"></span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="layui-card">
                <div class="layui-card-header">添加标签</div>
                <div class="layui-card-body">
                    <div class="add-tags">
                        <span class="tags-show-block layui-input">
                              <input class="add-tags-dynamic-input " name="text" type="text"
                                     id="tags-add-text"
                                     autocomplete="off">
                        </span>

                    </div>
                    <div class="add-tags-btn">
                        <span>添加标签，可用逗号(,)分隔</span>
                        <input class="layui-btn" id="add-tags"
                               type="button" value="添加">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/static/plugins/layuiadmin/layui/layui.js"></script>
<script src="/static/js/common.js" type="text/javascript"></script>
<script th:inline="none">

    layui.config({
        base: '/static/plugins/layuiadmin/' //静态资源所在路径
    }).extend({
        index: 'lib/index'
        , mouseRightMenu: '/mouseRightMenu'
    }).use(['index', 'mouseRightMenu', 'layer'], function () {
        var $ = layui.jquery
            , layer = layui.layer
            , mouseRightMenu = layui.mouseRightMenu;
        computeInputWidth()

        doRenderTags('.tags-content > ul > li')
        document.oncontextmenu = function () {
            return false;
        }
        var token;
        ajaxApiPost(
            "/api/admin/token/generate",
            JSON.stringify({
                pageId: 'T14',
            }),
            function (res) {
                token = res.token;
            }
        );


        $('.tags-content > ul > li').bind("contextmenu", function (e) {
            var data = {oid: $(this).data('id'), text: $(this).data('text')}
            var menu_data = [
                {'data': data, 'type': 1, 'title': '编辑'},
                {'data': data, 'type': 2, 'title': '删除'},

            ]
            mouseRightMenu.open(menu_data, false, function (d) {
                if (d.type == 1) {
                    layer.open({
                        type: 2
                        , title: '标签编辑'
                        , content: '/admin/tags/edit/' + d.data.oid
                        , area: ['450px', '200px']
                        , btn: ['确定', '取消']
                        , yes: function (index, layero) {
                            var iframeWindow = window['layui-layer-iframe' + index]
                                , submitID = 'replyComm-submit'
                                , submit = layero.find('iframe').contents().find('#' + submitID);

                            //监听提交
                            iframeWindow.layui.form.on('submit(' + submitID + ')', function (formData) {
                                var field = formData.field; //获取提交的字段

                                ajaxPost(
                                    '/api/admin/tag/update',
                                    JSON.stringify({tagText: field.text, oid: d.data.oid, subToken: field.subToken}),
                                    "更新成功",
                                    function () {
                                        location.reload();
                                    }
                                );

                            });

                            submit.trigger('click');
                        }
                        , success: function (layero, index) {

                        }
                    });


                } else if (d.type == 2) {
                    alert_ask('确定要删除吗?', function () {
                        ajaxPost(
                            '/api/admin/tag/remove',
                            JSON.stringify({entityOid: d.data.oid}),
                            "删除成功",
                            function () {
                                location.reload();
                            }
                        );
                        // $a.css('display','none');
                        // layer.closeAll();
                    })
                }
            })
            return false;
        });

        // $('.added-tags-block').html("<span class='tags-show'>"+11+"</span>")
        $("#tags-add-text").unbind("input propertychange").bind('input propertychange', function () {
            if ($(this).prop('comStart')) return; // 中文输入过程中不截断
            var val = $(this).val();

            doProcessTagsInput(val);
        }).on('compositionstart', function () {
            $(this).prop('comStart', true);
        }).on('compositionend', function () {
            $(this).prop('comStart', false);
            var val = $(this).val();
            doProcessTagsInput(val);
        });

        var count = 0;
        var tagsArr = [];

        function doProcessTagsInput(val) {
            var validVal = doProcessInputVal(val)
            var lastVal = validVal.substr(validVal.length - 1);
            //解决复制粘贴字符中包含','的问题
            var tag = validVal.substr(0, validVal.length - 1).replace(/,+/g, "");
            validVal = tag + lastVal;

            $('#tags-add-text').val(validVal);

            if (lastVal == validVal && lastVal == ',') {
                $('#tags-add-text').val(tag);
                return;
            }

            var bodyWidth = $('body').css('width');
            var inputY = $('#tags-add-text').offset().left;
            var cnt = getWordsCnt(validVal);
            var isBr = false;
            if (inputY + cnt * 9.2 > parseInt(bodyWidth) - 50) {
                $('#tags-add-text').before('<br class="tags-show">');
                computeInputWidth()
                isBr = true;
            }
            //解决复制粘贴大于10个字符,并且最后一个字符是','的问题
            if (validVal.length == 11 && lastVal != ',' || validVal.length > 11) {
                alert_fail("提示", "标签最大支持10个字符！");
                $('#tags-add-text').val(validVal.substr(0, 10));
                return;
            }

            if (lastVal == ',') {
                var t = $('<span class="tags-show">' + html2Escape(tag) + '</span>')
                // $('.tags-show-block').appendTo('<span class="tags-show">' + tag + '</span>');
                // $('.tags-show-block').append(t);
                if ((inputY + cnt * 9.2 > parseInt(bodyWidth) - 60) && !isBr) {
                    $('#tags-add-text').before('<br class="tags-show">');
                    isBr = true;
                }
                $('#tags-add-text').before(t);
                doRenderTag('.tags-show:last', count++);
                $('#tags-add-text').val('');
                computeInputWidth()
                tagsArr.push(tag);
                // console.log(parseInt(t.css('width'))/cnt)
            }


        }

        var firstTime = new Date();
        var delCount = 0;
        var timeOut = 0;
        $("#tags-add-text").on('keydown', function (e) {
            var keyCode = e.keyCode || e.where;
            if (isEmpty($('#tags-add-text').val()) && keyCode == 8) {
                if (delCount == 1) {
                    var secondTime = new Date();
                    delCount++;
                    if (secondTime - firstTime < 1000) {
                        $('.tags-show-block .tags-show:last').remove()
                        delCount = 0;
                        clearTimeout(timeOut)
                        tagsArr.pop()
                    }
                }

                if (delCount == 0 && $('.tags-show').size() > 0) {
                    firstTime = new Date();
                    delCount++;
                    var bc = $('.tags-show-block .tags-show:last').css("background-color")
                    $('.tags-show-block .tags-show:last').css("background-color", bc.replace('0.1', '0.3'))
                    timeOut = setTimeout(function () {
                        delCount = 0;
                        var bc = $('.tags-show-block .tags-show:last').css("background-color")
                        $('.tags-show-block .tags-show:last').css("background-color", bc.replace('0.3', '0.1'))
                    }, 1000)
                }

                computeInputWidth()
            }
        })


        function doProcessInputVal(val) {
            val = val.replace(/\r\n/g, "");
            val = val.replace(/\s/g, "");
            val = val.replace(/\t/g, "");
            return val;
        }


        function doRenderTags(doms) {
            var tags = $(doms);
            for (var i = 0; i < tags.length; i++) {
                doRenderTag(tags[i], i)
            }
        }

        function doRenderTag(dom, i) {

            var color = Math.random();
            var r = parseInt((color * (i + 1) * 1234) % 254);
            var g = parseInt((color * (i + 1) * 4321) % 254);
            var b = parseInt((color * (i + 1) * 2222) % 254);
            $(dom).css("background-color", "rgba(" + r + "," + g + "," + b + ",0.1)")
            $(dom).css("border", "  1px rgba(" + r + "," + g + "," + b + ",1) solid")
        }

        function computeInputWidth() {
            var bodyWidth = $('body').css('width');
            // var spanWidth = $('.tags-show-block').css('width');
            var inputY = $('#tags-add-text').offset().left;
            // $('.tags-show-block').css('width',(parseInt(spanWidth)+25)+'px');
            $('.add-tags-dynamic-input').css('width', (parseInt(bodyWidth) - inputY - 40) + 'px');
        }

        $('#add-tags').click(function () {
            ajaxPost(
                '/api/admin/tag/add/list',
                JSON.stringify({tagList: tagsArr, subToken: token}),
                "添加成功",
                function () {
                    location.reload();
                }
            );


        })

    })
</script>
</body>
</html>