<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta content="webkit" name="renderer">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0"
          name="viewport">
    <link href="/static/plugins/layuiadmin/layui/css/layui.css" media="all" rel="stylesheet">
    <link href="/static/css/admin.css" media="all" rel="stylesheet">
    <title>编辑文章</title>
</head>
<body>
<div class="art-main">
    <div class="art-content">
        <div class="articleinfo">
            <p>撰写新文章</p>
            <input autocomplete="off" class="layui-input" id="art-title" name="title" placeholder="键入标题"
                   th:value="${article.title}"
                   type="text" value="">
            <label for="art-author">作者：</label><input autocomplete="off" class="layui-input" id="art-author"
                                                      name="author"
                                                      placeholder="请输入作者" th:value="${article.author}"
                                                      type="text">
        </div>
        <div class="textareas">
            <textarea id="mytextarea" name="article">
            </textarea>

        </div>

        <div style="display:none;">
            <form action="{:Url('index/index/articlePreview')}" id="form-articlePreview" method="post" target="_blank">
                <input id="artpre-title" name="title" type="hidden">
                <input id="artpre-author" name="author" type="hidden">
                <input id="artpre-content" name="content" type="hidden">
                <input id="artpre-type" name="type" type="hidden">
            </form>
        </div>

        <div class="layui-fluid layadmin-message-fluid">
            <div class="layui-row">
                <div class="layui-col-md12">
                    <div class="art-comment layui-card" id="art-comment">
                        <div class="layui-card-body">
                            <button class="layui-btn add-comment">添加评论</button>
                        </div>
                        <div class="layui-card-body comment-input" style="display: none">
                            <div class="layui-form-item layui-form-text">
                                <textarea class="layui-textarea" id="comm-content" name="comm-content"
                                          placeholder="请输入内容"></textarea>
                            </div>
                            <div class="layui-form-item">
                                <div class="layui-input-block layui-input-right">
                                    <button class="comment-btn layui-btn" id="addComment">提交评论</button>
                                </div>
                            </div>
                        </div>
                        <!--                        comment-->
                        <div id="commentView"></div>
                    </div>

                </div>
            </div>
        </div>
    </div>
    <div class="art-pub-rightsider">
        <div class="choosetags">
            <p>文章标签</p>
            <div class="choosed">
                <span th:each="tag:${artTags}" th:inline="text">[[${tag.content}]]
                    <span class="tags-id" style="display: none" th:text="${tag.oid}"></span><a>×</a>
                </span>
            </div>
            <div></div>
            <div class="tags">
                <span th:each="tag:${tags}" th:inline="text">[[${tag.content}]]
                    <span class="tags-id" style="display: none" th:text="${tag.oid}"></span>
                </span>
            </div>
        </div>
        <div class="articletyle">
            <p>文章分类</p>
            <label>请选择文章分类:</label>
            <div class="select">
                <div class="layui-card layui-form" lay-filter="component-form-element">
                    <select lay-search lay-verify="required" name="city" th:field="${article.typeId}">
                        <option style="color: #777" th:each="menu:${menuList}" th:text="${menu.text}"
                                th:value="${menu.oid}"></option>
                    </select>
                </div>
            </div>

        </div>
        <div class="articleimg">
            <p>缩略图</p>
            <div class="selimg">

                <div class="layui-upload ">
                    <button class="layui-btn" id="test1" type="button">上传图片</button>
                    <div class="layui-upload-list imgupload">
                        <img class="layui-upload-img" id="breimg" style="margin-left: 5px" th:src="${article.imgSrc}"
                             width="270">
                        <p id="demoText"></p>
                        <input id="imgsrc" name="Img" style="visibility: hidden" value=""/>
                    </div>
                </div>

            </div>
        </div>
        <div class="published">
            <p>文章发布</p>
            <div>
                <span style="text-space: 2"
                      th:text="'&nbsp;&nbsp;当前状态: '+(${article.status} eq 1?'已发布':(${article.status} eq 0? '草稿':'回收站'))">当前状态:
                </span>
            </div>
            <div class="btns-opt" style="margin-left: 10px;padding-bottom: 5px">
                <button class="layui-btn layui-btn-primary layui-btn-sm" id="articlePreview">文章预览</button>
            </div>
            <a><i class="iconfont">&#xe606;</i> 公开度：<span id="published-public"
                                                          th:text="${article.visitType == -1 ? '密码':(article.visitType == 0 ? '私密':(article.visitType == 2?'置顶':'公开' ))}"></span></a>&nbsp;
            <a id="edit">编辑</a>
            <form class="layui-form" lay-filter="component-form-element" method="post">
                <div class="layui-form-item" id="ispublic-form">
                    <div class="layui-input-block">
                        <input checked class="ispublic-radio" id="public" lay-filter="public" name="isPublic"
                               th:checked="${article.visitType == 1 || article.visitType == 2}"
                               title="公开" type="radio"
                               value="1">
                        <span id="hometop1"><input id="hometop" lay-skin="primary"
                                                   th:checked="${article.visitType == 2}" title="将文章置于首页顶端"
                                                   type="checkbox" value="2"></span><br>
                        <input class="ispublic-radio" id="passw" lay-filter="passw" name="isPublic"
                               th:checked="${article.visitType == -1}"
                               title="密码保护" type="radio"
                               value="-1"><br>
                        <input autocomplete="off" class="layui-input passw"
                               id="passw-content"
                               placeholder="密码"
                               th:style="${article.visitType == -1 ? 'display: inline-block' : 'display: none'}"
                               th:value="${article.password}"
                               type="password">
                        <input autocomplete="off" class="layui-input passw"
                               id="passw-content-confirm"
                               placeholder="确认密码"
                               th:style="${article.visitType == -1 ? 'display: inline-block' : 'display: none'}"
                               type="password">
                        <input class="ispublic-radio" id="secret" lay-filter="secret" name="isPublic"
                               th:checked="${article.visitType == 0}"
                               title="私密" type="radio" value="0">
                    </div>
                    <span id="pwd-tips" style="color: red;display: none"></span>
                    <div class="btns-opt" id="btns0" style="display: block">
                        <button class="layui-btn layui-btn-sm" id="btn-ispublic-sure">确定</button>
                        <button class="layui-btn layui-btn-primary layui-btn-sm" id="btn-ispublic-cancel">取消</button>
                    </div>
                </div>
                <div>
                    <div id="isComment">
                        <input checked id="is-comment" name="isComment" th:checked="${article.isComment == 1}"
                               title="是否可以评论" type="checkbox">
                    </div>
                </div>
            </form>
            <div></div>
            <div id="btns1">
                <div id="btns1-1">
                    <button class="layui-btn layui-btn-primary" id="cancel">重置</button>
                    <button class="layui-btn layui-btn-danger" id="remove-del">移至回收站</button>
                </div>
                <div id="btns1-2">
                    <button class="layui-btn layui-btn-primary" id="published-save" th:if="${article.status} eq 0">保存
                    </button>
                    <button class="layui-btn" id="published-pub" th:if="${article.status} eq 0">发布</button>
                    <button class="layui-btn" id="published-update" th:if="${article.status} eq 1">更新</button>
                </div>
            </div>
        </div>
        <div class="end"></div>
    </div>
    <div style="clear: both"></div>
</div>
<input id="artOid" th:value="${artOid}" type="hidden">
<div></div>
<script src="/static/plugins/layuiadmin/layui/layui.js"></script>
<script src="/static/plugins/tinymce/tinymce.min.js" type="text/javascript"></script>
<script src="/static/js/common.js" type="text/javascript"></script>

<script id="commentTemplate" type="text/html">

    <div class="layui-col-md12 comment-content ">
        {{# layui.each(d, function(index, comm){ }}
        <div class="comment-list">
            <div class="media-body">
                <a href="javascript:" class="media-left" style="float: left;">
                    <img src="{{ comm.headImg }}" height="46px"
                         width="46px">
                </a>
                <div class="pad-btm">
                    <p class="fontColor">
                        <a href="javascript:">{{ comm.user }}</a>
                        <span style="float: right">
                                            <button class="layui-btn layui-btn-sm reply"
                                                    data-id="{{ comm.oid}}">回复</button>
                                            <button class="layui-btn layui-btn-sm layui-btn-danger del"
                                                    data-id="{{ comm.oid}}">删除</button>
                                        </span>
                    </p>
                    <p class="min-font">
                        <a href="javascript:">{{ comm.date }}</a>
                    </p>
                </div>
                <p class="message-text">{{=comm.content}}</p>
            </div>
            <div class="comment-content-reply">
                {{# layui.each(comm.replyList, function(index, rep){ }}
                <div>
                    <div class="media-body">
                        <a href="javascript:" class="media-left" style="float: left;">
                            <img src="{{rep.headImg}}" height="46px"
                                 width="46px">
                        </a>
                        <div class="pad-btm">
                            <p class="fontColor">
                                <a href="javascript:">{{rep.user}}</a>
                                <span style="float: right">
                                                        <button class="layui-btn layui-btn-sm reply"
                                                                data-id="{{ comm.oid}}">回复</button>
                                                        <button class="layui-btn layui-btn-sm layui-btn-danger del"
                                                                data-id="{{ comm.oid}}">删除</button>
                                                 </span>
                            </p>
                            <p class="min-font">
                                <a href="javascript:">回复给{{rep.parentUserName}}</a>
                                <a href="javascript:">{{rep.date}}</a>
                            </p>
                        </div>
                        <p class="message-text">{{=rep.content}}</p>
                    </div>
                </div>
                {{# }); }}
            </div>
        </div>
        {{# }); }}
    </div>


</script>
<script th:inline="javascript">
    tinymceInit("#mytextarea");

    layui.use(['layer', 'form', 'element', 'upload', 'laytpl'], function () {
        var form = layui.form
            , $ = layui.jquery
            , upload = layui.upload
            , laytpl = layui.laytpl
        ;

        /*<![CDATA[*/
        var html = /*[[${article.content}]]*/'';
        var artOid = /*[[${article.oid}]]*/'';
        /*]]>*/
        var data;
        ajaxApiPost(
            "/api/admin/comment/query/article/list",
            JSON.stringify({
                entityOid: artOid,
            }),
            function (res) {
                data = res.commentList;
                renderComm(data);
            }
        );

        renderComm();

        function renderComm() {
            ajaxApiPost(
                "/api/admin/comment/query/article/list",
                JSON.stringify({
                    entityOid: artOid,
                }),
                function (res) {
                    data = res.commentList;
                    var getTpl = document.getElementById('commentTemplate').innerHTML
                        , view = document.getElementById('commentView');
                    laytpl(getTpl).render(data, function (html) {
                        view.innerHTML = html;
                    });
                }
            );

        }

        var btnShow = false;
        tinyMCE.activeEditor.setContent(html);
        $('.add-comment').click(function () {
            if (!btnShow) {
                $(".comment-input").css('display', 'block');
                btnShow = true;
            } else {
                $(".comment-input").css('display', 'none');
                btnShow = false;
            }
        })


        $('#commentView').on('click', '.reply', function () {
            var poid = $(this).attr('data-id')
            console.log(poid)
            layer.open({
                type: 2
                , title: '回复评论'
                , content: '/admin/comment/reply'
                , area: ['450px', '300px']
                , btn: ['确定', '取消']
                , yes: function (index, layero) {
                    var iframeWindow = window['layui-layer-iframe' + index]
                        , submitID = 'replyComm-submit'
                        , submit = layero.find('iframe').contents().find('#' + submitID);

                    //监听提交
                    iframeWindow.layui.form.on('submit(' + submitID + ')', function (formData) {
                        var field = formData.field; //获取提交的字段
                        var headImgUrl = "/static/comm/img/headimg/" + Math.ceil(Math.random() * 10) + ".jpg";

                        //提交 Ajax 成功后，静态更新表格中的数据
                        ajaxPost(
                            "/api/admin/comment/reply",
                            JSON.stringify({
                                content: field.content,
                                parentOid: poid,
                                artOid: artOid,
                                headImgUrl: headImgUrl
                            }),
                            "回复成功",
                            function () {
                                renderComm();
                                layer.close(index); //关闭弹层
                            }
                        );

                    });

                    submit.trigger('click');
                }
                , success: function (layero, index) {

                }
            });
        });

        $('.art-comment').on('click', '.comment-btn', function () {

            /*<![CDATA[*/
            var commid = /*[[${lastCommOid}]]*/'';
            /*]]>*/
            commid++;
            var username = '博主:';
            var qq = '00000000';
            var curtime = formatDate(new Date().getTime());
            var headImgUrl = "/static/comm/img/headimg/" + Math.ceil(Math.random() * 10) + ".jpg";
            var commentext = $('#comm-content').val();
            var replyId = 0;
            ajaxPost(
                "/api/admin/comment/reply",
                JSON.stringify({
                    content: commentext,
                    username: username,
                    qq: qq,
                    artOid: artOid,
                    parentOid: replyId,
                    headImgUrl: headImgUrl
                }),
                "评论成功",
                function () {
                    renderComm();
                    $(".comment-input").css('display', 'none');
                    btnShow = false;
                }
            );


        })


        $('#commentView').on('click', '.del', function () {
            var oid = $(this).attr('data-id');
            alert_ask('确定要删除此评论(所有回复评论也将会全部删除)?', function () {
                ajaxPost(
                    "/api/admin/comment/remove",
                    JSON.stringify({entityOid: oid}),
                    "删除成功",
                    function () {
                        renderComm();
                    }
                );


            })


        });


        spans = $('.choosetags').find('span');
        for (var i = 0; i < spans.length; i++) {
            var color = Math.random();
            var r = parseInt((color * (i + 1) * 1234) % 254);
            var g = parseInt((color * (i + 1) * 4321) % 254);
            var b = parseInt((color * (i + 1) * 2222) % 254);
            $(spans[i]).css("background-color", "rgba(" + r + "," + g + "," + b + ",0.1)");
            $(spans[i]).css("border", "  1px rgba(" + r + "," + g + "," + b + ",1) solid");

        }
        $('.choosed').on('click', 'a', function () {
            $(this).parent().remove();
        })
        $('.tags>span').click(function () {
            var flag = 0, choosed = $('.choosed>span');
            for (var i = 0; i < choosed.length; i++) {
                var obj = $(choosed[i]).clone();
                obj.find('a').remove();
                if (obj.text() == $(this).text()) {
                    flag = 1;
                }
            }
            if (!flag) {
                var choosed = $('.choosed');
                var add = $('<span></span>');
                var tagschoosed = $(this).clone();
                tagschoosed.html($(this).html() + '<a>×</a>').appendTo(choosed);
            }

        })
        var status1 = 0;
        $('#edit').click(function () {
            if (status1 == 0) {
                $('#ispublic-form').css("display", "block");
                status1 = 1;
            } else if (status1 == 1) {
                $('#ispublic-form').css("display", "none");
                $('#pwd-tips').text('')
                status1 = 0;
            }
        })


        form.on('radio(public)', function (data) {
            $('#hometop1').show();
            $('#passw-content').hide();
            $('#passw-content-confirm').hide();
            form.render();
        });
        form.on('radio(secret)', function (data) {
            $('#hometop1').show();
            $('#passw-content').hide();
            $('#passw-content-confirm').hide();
            form.render();
        });
        form.on('radio(passw)', function (data) {
            $('#hometop1').hide();
            $('#passw-content').show();
            $('#passw-content-confirm').show();
            form.render();
        });

        layui.use('upload', function () {
            var index;
            var $ = layui.jquery
                , upload = layui.upload;

            //普通图片上传
            var uploadInst = upload.render({
                elem: '#test1'
                , url: '/api/file/upload'
                , before: function (obj) {
                    //预读本地文件示例，不支持ie8
                    obj.preview(function (index, file, result) {
                        $('#breimg').attr('src', result); //图片链接（base64）
                    });
                    index = layer.load(0, {shade: false, offset: '400px'}, {time: 3000});
                }
                , done: function (res) {
                    layer.close(index);
                    // console.log(res);
                    // //如果上传失败
                    $('result').text(res.status);
                    //    alert(res.status);
                    if (res.status == '000000') {
                        layer.msg('上传成功', {
                            title: '提示'
                            //不自动关闭
                            , time: 1000
                            , icon: 6
                            , offset: '400px'
                        });
                        $('#imgsrc').val(res.file.url);
                    }
                    //上传成功
                }
                , error: function () {
                    layer.close(index);
                    layer.msg('上传出错：1', {
                        title: '提示'
                        //不自动关闭
                        , time: 1000
                        , icon: 5
                        , offset: '400px'
                    });
                    //演示失败状态，并实现重传
                    var demoText = $('#demoText');
                    demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-mini demo-reload">重试</a>');
                    demoText.find('.demo-reload').on('click', function () {
                        uploadInst.upload();
                    });
                }
            });
        });


        $('#btn-ispublic-cancel').click(function () {
            $('#ispublic-form').css("display", "none");
            $('#pwd-tips').text('')
            status1 = 0;
            return false;

        })
        $('#btn-ispublic-sure').click(function () {
            if (($('#passw-content').val() == null || $('#passw-content').val() == '') && $('#ispublic-form .ispublic-radio:checked').val() == -1) {
                $('#pwd-tips').text('密码不能为空').css('color', 'red').css('display', 'block')

            } else if (($('#passw-content').val() != $('#passw-content-confirm').val()) && $('#ispublic-form .ispublic-radio:checked').val() == -1) {
                $('#pwd-tips').text('两次密码不一致').css('color', 'red').css('display', 'block')
            } else if (status1 == 1) {
                $('#ispublic-form').css("display", "none");
                $('#pwd-tips').text('')
                status1 = 0;
                $('#published-public').text($('#ispublic-form .ispublic-radio:checked').attr('title'));

            }

            return false;
        })

        $('#published-update,#published-save,#published-pub').click(function () {
            var btntype;
            if ($(this).attr('id') == 'published-update') {
                btntype = 1;
            } else if ($(this).attr('id') == 'published-save') {
                btntype = 2;
            } else if ($(this).attr('id') == 'published-pub') {
                btntype = 3;
            }
            if (tinyMCE.activeEditor.getContent().replace(new RegExp('\n', 'g'), '') == '<!DOCTYPE html><html><head></head><body></body></html>') {
                alert_fail('提示', '文章不可为空！')
                return false;
            }
            if ($('#art-author').val() == null || $.trim($('#art-author').val()) == '' ||
                $('#art-title').val() == null || $.trim($('#art-title').val()) == '') {
                alert_fail('提示', '标题或作者不可为空！')
                return false;
            }
            var tagsId = [];
            var publishTemp = 1;
            var passw = 0;

            var data = $('.choosed>span>span');
            for (var i = 0; i < data.length; i++) {
                tagsId[i] = data.eq(i).text();
            }
            var typeid = $('.articletyle select').val()
            $('#type-id').val(typeid);
            publishTemp = $('#ispublic-form .ispublic-radio:checked').val();
            if ($('#ispublic-form .ispublic-radio:checked').val() == 1) {
                if ($('#hometop').prop('checked')) {
                    publishTemp = 2;

                }

            } else if ($('#ispublic-form .ispublic-radio:checked').val() == -1) {
                passw = $('#passw-content').val();
            }
            var iscomment = 0;
            if ($('#is-comment').prop('checked')) {
                iscomment = 1;

            }
            var title = $('#art-title').val();
            var author = $('#art-author').val();
            var articleContent = tinyMCE.activeEditor.getContent();
            var tags = tagsId;
            var type = typeid;
            var imgSrc = $('#imgsrc').val();
            var published = publishTemp == undefined ? 1 : publishTemp;
            var password = passw;
            var artid = $('#artOid').val()
            // //
            // console.log('title\t'+title)
            // console.log('author\t'+author)
            // // console.log('articleContent\t'+articleContent)
            // console_log.log('tags\t'+tags);
            // console.log('type\t'+type)
            // console.log('img\t'+imgSrc)
            // console.log('published\t'+published)
            // console.log('password\t'+password)
            if (btntype == 1) {
                ajaxPost(
                    '/api/admin/article/update',
                    JSON.stringify({
                        artOid: artid,
                        title: title,
                        author: author,
                        articleContent: articleContent,
                        tags: tags,
                        type: type,
                        imgSrc: imgSrc,
                        visitType: published,
                        password: password,
                        isComment: iscomment
                    }),
                    "更新成功"
                );

            } else if (btntype == 2) {
                ajaxPost('/api/admin/article/draft/save',
                    JSON.stringify({
                        artOid: artid,
                        title: title,
                        author: author,
                        articleContent: articleContent,
                        tags: tags,
                        type: type,
                        imgSrc: imgSrc,
                        visitType: published,
                        password: password,
                        isComment: iscomment
                    }),
                    "保存成功"
                )
            } else if (btntype == 3) {
                ajaxPost('/api/admin/article/draft/publish',
                    JSON.stringify({
                        artOid: artid,
                        title: title,
                        author: author,
                        articleContent: articleContent,
                        tags: tags,
                        type: type,
                        imgSrc: imgSrc,
                        visitType: published,
                        password: password,
                        isComment: iscomment
                    }),
                    "发布成功"
                )


            }


        })
        $('#articlePreview').click(function () {
            var title = $('#art-title').val();
            var author = $('#art-author').val();
            var articleContent = tinyMCE.activeEditor.getContent();
            var type = $('.articletyle select:selected').text();
            $('#artpre-title').val(title);
            $('#artpre-author').val(author);
            $('#artpre-content').val(articleContent);
            $('#artpre-type').val(type);

            $('#form-articlePreview').submit();
            window.alert = function () {
                return false;
            };
        })
    });
</script>


</body>
</html>