<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <link href="/static/plugins/layuiadmin/layui/css/layui.css" media="all" rel="stylesheet">
    <link href="/static/css/admin.css" media="all" rel="stylesheet">
    <link href="/static/plugins/jquery-ui/jquery-ui.min.css" media="all" rel="stylesheet">
    <title>菜单管理</title>
</head>
<body>
<div class="menu">
    <p>添加菜单</p>
    <span> <input id="menucheck" type="checkbox"><label
            for="menucheck">编辑菜单</label></span>
    <span>首页</span>
    <ul class="sortable">

        <li class="sorts" th:attr="data-id=${m.oid}" th:each="m:${menu}">
            <div class="menu_content">
                <span th:text="${m.text}"></span>
                <span class="del_menu" style="display: none" th:attr="data-id=${m.oid}">×</span>
                <div class="menu_edit">
                    <button class="layui-btn menu_edit_btn" th:attr="data-id=${m.oid}">编辑</button>
                </div>
            </div>
            <ul>
                <li th:each="s:${m.subMenus}">
                    <div class="menu_content">
                        <span th:text="${s.text}"></span>
                        <span class="del_menu" style="display: none" th:attr="data-id=${s.oid}">×</span>
                        <div class="menu_edit">
                            <button class="layui-btn menu_edit_btn" th:attr="data-id=${s.oid}">编辑</button>
                        </div>
                    </div>
                </li>

                <li class="addMenu" th:attr="data-id=${m.oid}"><i class="iconfont">&#xe613;</i></li>

            </ul>

        </li>
        <li class="addMenu" data-id="0" th:if="${menu.size() < 9}"><i class="iconfont">&#xe613;</i></li>
    </ul>
    <div style="display:none;">
        <form id="menuliform" method="post">
            <input class="text" id="menuli" name="menuli">
        </form>
    </div>
    <div style="display:none;">
        <form id="typeliform" method="post">
            <input class="text" id="typeli" name="typeli">
        </form>
    </div>

</div>
<script src="/static/plugins/layuiadmin/layui/layui.js"></script>
<script src="/static/comm/js/jquery.min.js"></script>
<script src="/static/plugins/jquery-ui/jquery-ui.min.js"></script>
<script src="/static/js/common.js" type="text/javascript"></script>
<script>
    layui.use(['layer', 'form', 'element', 'upload'], function () {
        var form = layui.form
            , $ = layui.jquery;
        $("#menucheck").click(function () {
            if ($(this).is(':checked')) {
                menuEdit();

            } else {
                $('div.menu ul>li>div span:nth-child(2)').css('display', 'none');
                $('.menu_edit').css('display', 'none');
                $(function () {
                    $('.sortable').sortable('destroy')
                })

            }
        })

        function menuEdit() {
            $('div.menu ul>li>div span:nth-child(1)').css('cursor', 'text');
            $('div.menu ul>li>div span:nth-child(2)').css('display', 'inline-block');
            $('.menu_edit').css('display', 'block');

            var index = [];
            // index[0]=new Array();
            // index[1]=new Array();
            $(function () {
                $('.sortable').sortable({
                    cursor: 'move',
                    items: '.sorts',
                    update: function (event, ui) {

                        for (var i = 0; i < $('.sorts').length; i++) {

                            var indextext = $('.sorts').eq(i).attr("data-id")
                            index[i] = indextext;
                        }
                        console.log(index)
                        ajaxPost(
                            "/api/admin/menu/sort",
                            JSON.stringify({
                                entityOidList: index
                            }),
                            "更新成功"
                        );

                    },
                }).disableSelection();
            })
            $('.menu_edit_btn').click(function () {
                var id = $(this).attr("data-id");
                layer.open({
                    type: 2
                    , title: '菜单编辑'
                    , content: '/admin/menu/edit/' + id
                    , area: ['500px', '400px']
                    , btn: ['确定', '取消']
                    , yes: function (index, layero) {
                        var iframeWindow = window['layui-layer-iframe' + index]
                            , submitID = 'replyComm-submit'
                            , submit = layero.find('iframe').contents().find('#' + submitID);

                        //监听提交
                        iframeWindow.layui.form.on('submit(' + submitID + ')', function (formData) {
                            var field = formData.field; //获取提交的字段

                            //提交 Ajax 成功后，静态更新表格中的数据
                            ajaxPost(
                                "/api/admin/menu/update",
                                JSON.stringify({
                                    name: field.name,
                                    text: field.text,
                                    icon: field.icon,
                                    url: field.url,
                                    oid: id
                                }),
                                "更新成功",
                                function () {
                                    layer.close(index); //关闭弹层
                                    location.reload();
                                }
                            );
                        });

                        submit.trigger('click');
                    }
                    , success: function (layero, index) {

                    }
                });
            });


        }

        // 添加菜单
        $('.addMenu').click(function () {
            var pid = $(this).attr("data-id");
            layer.open({
                type: 2
                , title: '添加菜单'
                , content: '/admin/menu/add'
                , area: ['500px', '400px']
                , btn: ['确定', '取消']
                , yes: function (index, layero) {
                    var iframeWindow = window['layui-layer-iframe' + index]
                        , submitID = 'replyComm-submit'
                        , submit = layero.find('iframe').contents().find('#' + submitID);

                    //监听提交
                    iframeWindow.layui.form.on('submit(' + submitID + ')', function (formData) {
                        var field = formData.field; //获取提交的字段

                        //提交 Ajax 成功后，静态更新表格中的数据
                        ajaxPost(
                            "/api/admin/menu/add",
                            JSON.stringify({
                                name: field.name,
                                text: field.text,
                                icon: field.icon,
                                url: field.url,
                                parentOid: pid
                            }),
                            "添加成功",
                            function () {
                                layer.close(index); //关闭弹层
                                location.reload();
                            }
                        );
                    });

                    submit.trigger('click');
                }
                , success: function (layero, index) {

                }
            });
        })
        //菜单删除
        $('.del_menu').click(function () {
            var id = $(this).attr("data-id");
            ajaxApiPost(
                "/api/admin/menu/validate/submenu",
                JSON.stringify({
                    entityOid: id
                }),
                function (data) {
                    if (data.isSuccess == "N") {
                        layer.confirm(data.resultMsg, function (index) {
                            layer.close(index);
                        });
                    } else {
                        ajaxApiPost(
                            "/api/admin/menu/validate/article/exist",
                            JSON.stringify({
                                entityOid: id
                            }),
                            function (data) {
                                if (data.isSuccess == "N") {
                                    layer.confirm(data.resultMsg, function (index) {
                                        layer.close(index);
                                    });
                                } else {
                                    layer.confirm("确定要删除此菜单嘛？", function (index) {
                                        ajaxPost(
                                            "/api/admin/menu/remove",
                                            JSON.stringify({
                                                entityOid: id
                                            }),
                                            "删除成功",
                                            function () {
                                                layer.close(index);
                                                location.reload();
                                            }
                                        );
                                    });

                                }

                            }
                        );
                    }

                }
            );
        })
    })
</script>
</body>
</html>