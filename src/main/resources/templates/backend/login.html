<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta content="webkit" name="renderer">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0"
          name="viewport">
    <link href="/static/plugins/layuiadmin/layui/css/layui.css" media="all" rel="stylesheet">
    <link href="/static/plugins/layuiadmin/style/login.css" media="all" rel="stylesheet">
    <title>管理员登录</title>
    <style>

        .show {
            display: block;
        }

        .hide {
            display: none;;
        }
    </style>
</head>
<body>


<div class="layadmin-user-login layadmin-user-display-show" id="LAY-user-login" style="display: none;">

    <div class="layadmin-user-login-main login-content">
        <div class="layadmin-user-login-box layadmin-user-login-header">
            <h2>管理员登录</h2>
        </div>
        <div class="layadmin-user-login-box layadmin-user-login-body layui-form">
            <div class="layui-form-item">
                <label class="layadmin-user-login-icon layui-icon-username layui-icon"
                       for="LAY-user-login-username"></label>
                <input class="layui-input" id="LAY-user-login-username" lay-verify="required" name="username"
                       placeholder="用户名" autocomplete="off" type="text">
            </div>
            <div class="layui-form-item">
                <label class="layadmin-user-login-icon layui-icon layui-icon-password"
                       for="LAY-user-login-password"></label>
                <input class="layui-input" id="LAY-user-login-password" lay-verify="required" name="password"
                       placeholder="密码" type="password">
            </div>
            <div class="layui-form-item inputs" th:if="${isCaptcha}">
                <div id="embed-captcha" style="margin-right: 15px"></div>
                <p id="wait" class="show">正在加载验证码......</p>
            </div>
            <div class="layui-form-item" style="margin-bottom: 20px;">
                <input lay-skin="primary" name="remember" title="记住密码" type="checkbox">
                <a class="layadmin-user-jump-change layadmin-link" href="forget.html" style="margin-top: 7px;">忘记密码？</a>
            </div>
            <div class="layui-form-item">
                <button class="layui-btn layui-btn-fluid" lay-filter="user-login-submit" lay-submit>登 录</button>
            </div>

        </div>
    </div>

    <script src="/static/plugins/layuiadmin/layui/layui.js"></script>
    <script src="/static/comm/js/geetest.js" type="text/javascript"></script>
    <script src="/static/js/common.js" type="text/javascript"></script>

    <script th:inline="javascript">
        layui.config({
            base: '/static/plugins/layuiadmin/' //静态资源所在路径
        }).extend({
            index: 'lib/index' //主入口模块
        }).use(['index', 'form', 'element'], function () {
            var $ = layui.$
                , form = layui.form;

            /*<![CDATA[*/
            var isCaptcha = /*[[${isCaptcha}]]*/true;
            /*]]>*/
            if (isCaptcha) {

                var handlerEmbed = function (captchaObj) {
                    var f = 1;
                    layui.form.on('submit(user-login-submit)', function (formData) {
                        var validate = captchaObj.getValidate();
                        var field = formData.field;
                        if (!validate) {
                            alert_fail("提示", "请先完成验证!");
                        } else {
                            $.ajax({
                                url: "/api/admin/login/captcha/verify",
                                type: 'post',
                                dataType: 'json',
                                data: {

                                    geetest_challenge: validate.geetest_challenge,
                                    geetest_validate: validate.geetest_validate,
                                    geetest_seccode: validate.geetest_seccode,
                                },
                                success: function (data) {
                                    if (data.status == "000000") {
                                        login(field);

                                    } else {
                                        alert_fail("验证失败", "验证码验证失败，请刷新页面重试！")
                                        setTimeout(function () {
                                            location.reload();
                                        }, 1000);
                                    }


                                }
                            })
                        }
                    });
                    // 将验证码加到id为captcha的元素里，同时会有三个input的值：geetest_challenge, geetest_validate, geetest_seccode
                    captchaObj.appendTo("#embed-captcha");
                    captchaObj.onReady(function () {
                        $("#wait")[0].className = "hide";
                    });
                    // 更多接口参考：http://www.geetest.com/install/sections/idx-client-sdk.html
                };

                $.ajax({
                    // 获取id，challenge，success（是否启用failback）
                    url: "/api/admin/login/captcha/init?t=" + (new Date).getTime(), // 加随机数防止缓存
                    type: "get",
                    dataType: "json",
                    success: function (res) {
                        // 使用initGeetest接口
                        // 参数1：配置参数
                        // 参数2：回调，回调的第一个参数验证码对象，之后可以使用它做appendTo之类的事件
                        initGeetest({
                            gt: res.gt,
                            challenge: res.challenge,
                            new_captcha: res.newCaptcha,
                            product: "float", // 产品形式，包括：float，embed，popup。注意只对PC版验证码有效
                            offline: !res.success,// 表示用户后台检测极验服务器是否宕机，一般不需要关注
                            width: '313px',
                            // 更多配置参数请参见：http://www.geetest.com/install/sections/idx-client-sdk.html#config
                        }, handlerEmbed);
                    },

                });
            } else {
                layui.form.on('submit(user-login-submit)', function (formData) {
                    var field = formData.field;
                    login(field);

                });
            }


            function login(field) {
                ajaxPost(
                    "/api/admin/login/auth",
                    JSON.stringify({
                        username: field.username,
                        password: field.password,
                    }),
                    "登录成功",
                    function () {
                        location.href = "/admin"
                    },
                    function () {
                        location.reload();
                    }
                );
            }

        })

    </script>
</body>
</html>