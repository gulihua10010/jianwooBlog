<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.jianwoo.blog.dao.biz.mapper.MessageBoardBizMapper">
    <resultMap id="BaseResultMap" type="cn.jianwoo.blog.entity.MessageBoard">
        <id column="OID" jdbcType="BIGINT" property="oid" />
        <result column="USER_ID" jdbcType="VARCHAR" property="userId" />
        <result column="USER_NAME" jdbcType="VARCHAR" property="userName" />
        <result column="USER_NICK" jdbcType="VARCHAR" property="userNick" />
        <result column="CLIENT_IP" jdbcType="VARCHAR" property="clientIp" />
        <result column="USER_REGION" jdbcType="VARCHAR" property="userRegion" />
        <result column="PUSH_TIME" jdbcType="TIMESTAMP" property="pushTime" />
        <result column="PARENT_OID" jdbcType="BIGINT" property="parentOid" />
        <result column="REPLY_ROOT_OID" jdbcType="BIGINT" property="replyRootOid" />
        <result column="REPLY_TO_USER_ID" jdbcType="VARCHAR" property="replyToUserId" />
        <result column="REPLY_TO_USER_NAME" jdbcType="VARCHAR" property="replyToUserName" />
        <result column="REPLY_TO_USER_NICK" jdbcType="VARCHAR" property="replyToUserNick" />
        <result column="PRAISE_COUNT" jdbcType="BIGINT" property="praiseCount" />
        <result column="CONTACT_QQ" jdbcType="VARCHAR" property="contactQq" />
        <result column="CONTACT_WECHAT" jdbcType="VARCHAR" property="contactWechat" />
        <result column="CONTACT_WEIBO" jdbcType="VARCHAR" property="contactWeibo" />
        <result column="CONTACT_TEL" jdbcType="VARCHAR" property="contactTel" />
        <result column="CONTACT_EMAIL" jdbcType="VARCHAR" property="contactEmail" />
        <result column="AVATAR_SRC" jdbcType="VARCHAR" property="avatarSrc" />
        <result column="READ_STATUS" jdbcType="VARCHAR" property="readStatus" />
        <result column="REPLY_COUNT" jdbcType="BIGINT" property="replyCount" />
        <result column="TOTAL_REPLY_COUNT" jdbcType="BIGINT" property="totalReplyCount" />
        <result column="IS_DELETE" jdbcType="CHAR" property="isDelete" />
        <result column="CREATE_TIME" jdbcType="TIMESTAMP" property="createTime" />
        <result column="UPDATE_TIME" jdbcType="TIMESTAMP" property="updateTime" />
    </resultMap>
    <resultMap id="ResultMapWithExt" extends="BaseResultMap" type="cn.jianwoo.blog.entity.extension.MessageBoardExt">
        <result column="REPLY_TO" property="parentUserName" jdbcType="VARCHAR" javaType="java.lang.String"/>
        <result column="PRAISE_OID" property="praiseOid" jdbcType="BIGINT" javaType="java.lang.Long"/>
    </resultMap>
    <sql id="Base_Column_List">
        OID, USER_ID, USER_NAME, USER_NICK, CLIENT_IP, USER_REGION, PUSH_TIME, PARENT_OID,
    REPLY_ROOT_OID, REPLY_TO_USER_ID, REPLY_TO_USER_NAME, REPLY_TO_USER_NICK, PRAISE_COUNT,
    CONTACT_QQ, CONTACT_WECHAT, CONTACT_WEIBO, CONTACT_TEL, CONTACT_EMAIL, AVATAR_SRC,
    READ_STATUS, REPLY_COUNT, TOTAL_REPLY_COUNT, IS_DELETE, CREATE_TIME, UPDATE_TIME
    </sql>
    <sql id="Blob_Column_List">
        CONTENT
    </sql>
    <sql id="Ext_Column_List">
        M.OID, M.USER_ID, M.USER_NAME, M.USER_NICK, M.CLIENT_IP, M.USER_REGION, M.PUSH_TIME, M.PARENT_OID,
    M.REPLY_ROOT_OID, M.REPLY_TO_USER_ID, M.REPLY_TO_USER_NAME, M.REPLY_TO_USER_NICK, M.PRAISE_COUNT,
    M.CONTACT_QQ, M.CONTACT_WECHAT, M.CONTACT_WEIBO, M.CONTACT_TEL, M.CONTACT_EMAIL, M.AVATAR_SRC,
    M.READ_STATUS, M.REPLY_COUNT, M.TOTAL_REPLY_COUNT, M.IS_DELETE, M.CREATE_TIME, M.UPDATE_TIME,
    M.CONTENT
    </sql>

    <select id="selectRecentMessage" parameterType="java.lang.Integer" resultMap="ResultMapWithExt">
        SELECT
        <include refid="Ext_Column_List"/>
        FROM
        MESSAGE_BOARD M
        WHERE IS_DELETE = '0'
        ORDER BY
        M.UPDATE_TIME DESC
        LIMIT #{limit,jdbcType=INTEGER}
    </select>

    <select id="countWithUnreadMsg" resultType="java.lang.Long">
        SELECT COUNT(1)
        FROM MESSAGE_BOARD
          AND IS_DELETE = '0'
          AND IS_READ = 0
    </select>

    <select id="countAllMessage" resultType="java.lang.Long">
        select count(1)
        from MESSAGE_BOARD
        WHERE IS_DELETE = '0'
    </select>

    <select id="selectMessagePageList" parameterType="cn.jianwoo.blog.entity.query.MessageBoardPageQuery"
            resultMap="ResultMapWithExt">
        SELECT
        <include refid="Ext_Column_List"/>
        ,
        P.OID AS PRAISE_OID
        FROM
        MESSAGE_BOARD M LEFT JOIN BIZ_PRAISE P ON P.TYPE = '30' AND P.BIZ_OID = M.OID AND P.USER_IP = #{currentIp}
        WHERE
        1 = 1
        <!--        AND M.IS_DELETE = '0'                      -->
        <if test="parentOid != null">
            AND M.PARENT_OID = #{parentOid}
        </if>
        <if test="replyRootOid != null">
            AND M.REPLY_ROOT_OID = #{replyRootOid}
            AND M.IS_DELETE = '0'
        </if>
        ORDER BY
        <if test="parentOid == 0">
            <if test="orderWay == 10">
                M.TOTAL_REPLY_COUNT DESC,
                M.PRAISE_COUNT DESC,
                M.PUSH_TIME ASC
            </if>
            <if test="orderWay == 20">
                M.PUSH_TIME DESC,
                M.TOTAL_REPLY_COUNT DESC,
                M.PRAISE_COUNT ASC
            </if>
        </if>
        <if test="parentOid != 0">
            M.PUSH_TIME ASC
        </if>

        <if test="isLimit == true">
            LIMIT #{start}, #{rows}
        </if>
    </select>


    <select id="selectMessageRootCount"
            resultType="java.lang.Long">
        SELECT COUNT(1)
        FROM MESSAGE_BOARD M
        WHERE M.PARENT_OID = 0
          AND M.IS_DELETE = '0'

    </select>


    <select id="selectMessageExt" resultMap="ResultMapWithExt">
        SELECT
        <include refid="Ext_Column_List"/>
        FROM
        MESSAGE_BOARD M
        WHERE
        AND M.IS_DELETE = '0'
        ORDER BY
        M.UPDATE_TIME DESC
    </select>

    <select id="selectAllMessageExt" resultMap="ResultMapWithExt"
            parameterType="cn.jianwoo.blog.entity.query.MessageBoardQuery">
        SELECT
        M.OID,
        M.USER_ID,
        M.USER_NAME,
        M.USER_NICK,
        M.PUSH_TIME,
        M.CONTENT,
        M.REPLY_TO_USER_ID,
        M.REPLY_TO_USER_NAME,
        M.IS_DELETE,
        IF (
        M. PARENT_OID = -1,
        '博客',
        M. REPLY_TO_USER_NICK
        ) AS REPLY_TO_USER_NICK
        FROM
        MESSAGE_BOARD M
        <where>
            <if test="readStatus != null">
                AND M.READ_STATUS = #{readStatus}
            </if>
            <if test="oid != null">
                AND M.OID = #{oid}
            </if>
            AND M.IS_DELETE = '0'
        </where>

        <if test="orderByClause == null">
            ORDER BY
            M.PUSH_TIME DESC
        </if>
        <if test="orderByClause != null">
            ORDER BY #{orderByClause}
        </if>
    </select>

    <update id="updateMessagePraiseCnt">
        UPDATE MESSAGE_BOARD
        SET PRAISE_COUNT = PRAISE_COUNT + 1
        WHERE OID = #{oid,jdbcType=BIGINT}
          AND IS_DELETE = '0';
    </update>

    <update id="updateMessageReplyCnt">
        UPDATE MESSAGE_BOARD
        <if test="optType == '10'">
            SET REPLY_COUNT = REPLY_COUNT + 1
        </if>
        <if test="optType == '40'">
            SET REPLY_COUNT = REPLY_COUNT - 1
        </if>
        WHERE OID = #{oid,jdbcType=BIGINT}
<!--          AND IS_DELETE = '0';-->
    </update>

    <update id="updateMessageTotalReplyCnt">
        UPDATE MESSAGE_BOARD
        <if test="optType == '10'">
            SET TOTAL_REPLY_COUNT = TOTAL_REPLY_COUNT + 1
        </if>
        <if test="optType == '40'">
            SET TOTAL_REPLY_COUNT = TOTAL_REPLY_COUNT - 1
        </if>
        WHERE OID = #{oid,jdbcType=BIGINT}
<!--          AND IS_DELETE = '0';-->
    </update>
</mapper>